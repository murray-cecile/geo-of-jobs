---
title: "Validate LEHD data against other employment data sources"
author: "Cecile Murray"
date: "March 27â€¢, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Goal

The goal of this script is to cross-check the LEHD dataset against another commonly used data source, namely Moody's. 

## Setup

First, we'll run setup.R to load required packages and set some global variables.

```{r setting_up, message = FALSE, cache = TRUE}
library(here)
source(here("R", "setup.R"))
```

Next, we'll bring in some pre-prepared LEHD data and collapse it to the county level.

```{r prep_lehd, cache = TRUE, dependson = "setting_up"}
# bring in prepared LEHD dataset
load(here("temp", "prepped_LEHD_2015.Rdata"))

# collapse LEHD data to counties
lehd <- raw_lehd %>% mutate(stcofips = substr(fips, 1, 5)) %>%
  select(-fips) %>% group_by(stcofips) %>% summarize_all(sum, na.rm=TRUE)

```

Then, we bring in the Moody's data and do some reformatting; we end up with two data frames, one of which contains total employment and the other of which holds employment by industry. Notably, we've recoded federal, state, and local government employment so that it's all in one general government category, in order to match LEHD.

```{r prep_moodys, cache = TRUE}

# bring in the dataset (admittedly sloppy re-use of old code)
setwd("P:/Projects/Older Industrial Cities/Analysis/code/older_industrial_cities")
source("R/pull_employment_data.R")
rm(list=setdiff(ls(), "cty_comp"))
setwd(here("docs"))

emp <- separate(cty_comp, DBcode, c("industry", "sep", "geo"), sep = "A") %>%
  dplyr::rename_at(vars(num_range("", 1970:2016)), funs(paste0("y", .))) %>%
  select(stcofips, industry, num_range("y", 2002:2016))

# could drop the raw data frame
# rm(cty_comp)

# split off total employment into its own data frame
totemp15 <- emp %>% select(stcofips, industry, y2015) %>% filter(industry=="RET")

# modify emp to better match LEHD NAICS codes
emp %<>% filter(industry!="RET") %>%
  mutate(naics = gsub("RE", "naics_", industry),
         naics = ifelse(substr(naics, 7, 8)=="GV", "naics_GV", naics)) %>%
  select(-industry) %>% group_by(stcofips, naics) %>% summarize_all(sum, na.rm=TRUE)
```

## Compare totals by industry

Now we're ready to compare job totals from LEHD to Moody's. We'll start with the total count of jobs at the national level, then look at industry level totals.

```{r tot_check, dependson = c("prep_lehd", "prep_moodys")}
# merge LEHD and Moody's; calculate difference in job totals
tot_check <- lehd %>% select(stcofips, job_tot) %>%
  left_join(totemp15, by="stcofips") %>%
  mutate(m_tot = y2015 * 1000,
         delta = job_tot - m_tot,
         percent_delta = delta / m_tot) %>% filter(!is.na(m_tot))
```

Here's a plot:

```{r tot_check_plot, echo = FALSE, messages = FALSE, dependson = c("prep_lehd", "prep_moodys")}
# In most counties, the difference in total jobs is pretty small
ggplot(tot_check) +
  geom_histogram(aes(x = percent_delta)) +
  labs(title = "Percent Difference in Job Totals by County, LEHD less Moody's",
       x = "Percent difference (LEHD minus Moody's")
```

In total, LEHD undershoots Moody's by just under 3.8M jobs, or a little less than 3 percent.

```{r tot_check_sums, dependson=  c("prep_lehd", "prep_moodys")}
sum(tot_check$delta, na.rm=TRUE)
sum(tot_check$delta, na.rm=TRUE) / sum(tot_check$m_tot, na.rm=TRUE)
```

Next, we can look at differences by sector, and see that there are some significant differences there.

```{r industry_tot, dependson=c("prep_lehd", "prep_moodys")}
# now check by naics sector across all counties
naics_check <- lehd %>% select(stcofips, contains("naics")) %>%
  gather(key = "naics", value ="jobs", -stcofips) %>%
  mutate(naics2 = gsub("naics_", "", naics),
         naics2 = ifelse(naics2=="31to33", "MF",
                         ifelse(naics2=="44to45", "RT",
                                ifelse(naics2=="48to49", "RW", 
                                       ifelse(naics2=="92", "GV", naics2)))),
         naics = paste0("naics_", naics2)) %>% 
  select(-naics2) %>%
  left_join(select(emp, stcofips, naics, y2015), by=c("stcofips", "naics")) %>%
  select(-stcofips) %>% group_by(naics) %>% summarise_all(sum, na.rm=TRUE) %>%
  mutate(m_tot = y2015 * 1000,
         delta = jobs - m_tot,
         percent_delta = delta / m_tot, 
         short_name = gsub("naics_", "", naics)) %>%
  filter(!is.na(m_tot), naics!="naics_11") 

```

We can see some substantial differences in jobs counts by sector, especially in education (61), government (GV), utilities (22), and other services (81).

```{r industry_tot_plots, dependson="industry_tot"}
# plot job counts by sector
ggplot(gather(naics_check, key = "source", value = "job_ct", jobs, m_tot)) +
  geom_col(aes(x = reorder(short_name, -job_ct), y = job_ct, group = source,
               fill = source), position = "dodge") +
  labs(title = "Job Totals by Sector, LEHD vs. Moody's, 2015",
       x = "Sector", "Jobs")


# by industry, percentage differences are mostly small except in 61, 22, GV, 81
ggplot(naics_check) +
  geom_col(aes(x = reorder(short_name, -percent_delta), y = percent_delta*100))
```

## Compare across geography

The national totals probably mask some regional differences, so we can compare metro area job totals by sector to see whether there are any particularly wide gaps between the two sources.

```{r met_totals, dependson=c("prep_lehd", "prep_moodys")}
# collapse job totals to metro
met_check <- lehd %>% select(stcofips, job_tot) %>%
  left_join(totemp15, by="stcofips") %>%
  left_join(select(cbsa_xwalk, stcofips, cbsa, top100), by="stcofips") %>%
  select(-stcofips, -industry) %>% group_by(cbsa) %>% summarize_all(sum, na.rm=TRUE) %>%
  mutate(m_tot = y2015 * 1000,
         delta = job_tot - m_tot,
         percent_delta = delta / m_tot) %>% 
  filter(top100 > 0)

ggplot(met_check) +
  geom_col(aes(x = reorder(cbsa, -delta), y = delta)) +
  
```

```{r}
met_naics_check <- lehd %>% select(stcofips, contains("naics")) %>%
  gather(key = "naics", value ="jobs", -stcofips, -job_tot) %>%
  mutate(naics2 = gsub("naics_", "", naics),
         naics2 = ifelse(naics2=="31to33", "MF",
                         ifelse(naics2=="44to45", "RT",
                                ifelse(naics2=="48to49", "RW", 
                                       ifelse(naics2=="92", "GV", naics2)))),
         naics = paste0("naics_", naics2)) %>% 
  select(-naics2) %>%
  left_join(select(emp, stcofips, naics, y2015), by=c("stcofips", "naics")) %>%
  left_join(select(cbsa_xwalk, stcofips, cbsa, top100), by="stcofips") %>%
  filter(top100==1) %>%
  select(-stcofips) %>% group_by(cbsa, naics) %>% summarize_all(sum, na.rm=TRUE) %>%
  mutate(m_tot = y2015 * 1000,
         delta = jobs - m_tot)
```

